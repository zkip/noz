# This workflow will build and push a new container image to Alibaba Cloud Container Registry (ACR),
# and then will deploy it to Alibaba Cloud Container Service for Kubernetes (ACK), when a release is created.
#
# To use this workflow, you will need to complete the following set-up steps:
#
# 1. Create an ACR repository to store your container images.
#    You can use ACR EE instance for more security and better performance.
#    For instructions see https://www.alibabacloud.com/help/doc-detail/142168.htm
#
# 2. Create an ACK cluster to run your containerized application.
#    You can use ACK Pro cluster for more security and better performance.
#    For instructions see https://www.alibabacloud.com/help/doc-detail/95108.htm
#
# 3. Store your AccessKey pair in GitHub Actions secrets named `ACCESS_KEY_ID` and `ACCESS_KEY_SECRET`.
#    For instructions on setting up secrets see: https://developer.github.com/actions/managing-workflows/storing-secrets/
#
# 4. Change the values for the REGION_ID, REGISTRY, NAMESPACE, IMAGE, ACK_CLUSTER_ID, and ACK_DEPLOYMENT_NAME.
#

name: Build and Deploy to ACK

on:
  release:
    types: [created]

  workflow_dispatch:

# Environment variables available to all jobs and steps in this workflow.
env:
  REGION_ID: cn-hongkong
  REGISTRY: registry.cn-hongkong.aliyuncs.com
  NAMESPACE: zkip
  IMAGE: noz
  TAG: ${{ github.sha }}
  ACK_CLUSTER_ID: c20e02c8c37ad49f99c78e0c37dc7a806
  ACK_DEPLOYMENT_NAME: noz-deployment

jobs:
  build:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # Login to ACR
      - name: Login to ACR with the AccessKey pair
        uses: aliyun/acr-login@v1
        with:
          region-id: "${{ env.REGION_ID }}"
          access-key-id: "${{ secrets.ACCESS_KEY_ID }}"
          access-key-secret: "${{ secrets.ACCESS_KEY_SECRET }}"

      # Transfter auth file
      - name: Transfer files to target
        uses: garygrossgarten/github-action-scp@release
        with:
          rmRemote: true
          username: root
          host: "${{ secrets.CLUSTER_HOST }}"
          remote: /root/docker_auth/config.json
          local: "${{ env.DOCKER_CONFIG }}/config.json"
          privateKey: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDRSmU2Av7CLvy7iEP6+HfqUYRLru3NAoDynxZJ8jM62QFthxswx1I9Fv61mmBV9bWgHNWGXihc38hBKJQgfQ2LvXA7h80uNcrcQK8PY75GhcfxVF9hJJho21yi0umXshJ2VTmjMXlKlSbJ3B2gsSshYfrOs9Jj2EY5fGOYMM5M/lV1tUMrBl/0L2rqfpnHOsCqn0dY8hKpr9RwuJMXkm8oRisNKE63s/qqSkfiSjyNPh5xYfNUdg8D5u9Pnn22z8AbElIlD+uSTFSxh7W2irGfYKPe+Ng0i6afm78+us+mJ8THS0w5NekZR6dqKxQgs44bJqoEE+K/rwHDM4UBRteFFU5miusdaFLjwJ+ETfzDnVCpYqVzDttIrLK9tRK7+ZLgTDzLVWeUarW0NP7kj+Ud3088rvftTX4zQ9XnEQ/FDZSPfdaCiEcl4qOFrqxxFHstSnJpY1gUP8igurfPf+TXabXn0rTTsd35jTU9TZ+9OdVjiFP271Hi+EI7SoIMwMc= zpox@DESKTOP-J0STCU8"
      # # Buid and push image to ACR
      # - name: Build and push image to ACR
      #   run: |
      #     docker build --tag "$REGISTRY/$NAMESPACE/$IMAGE:$TAG" .
      #     docker push "$REGISTRY/$NAMESPACE/$IMAGE:$TAG"
      # # Scan image in ACR
      # - name: Scan image in ACR
      #   uses: aliyun/acr-scan@v1
      #   with:
      #     region-id: "${{ env.REGION_ID }}"
      #     access-key-id: "${{ secrets.ACCESS_KEY_ID }}"
      #     access-key-secret: "${{ secrets.ACCESS_KEY_SECRET }}"
      #     repository: "${{ env.NAMESPACE }}/${{ env.IMAGE }}"
      #     tag: "${{ env.TAG }}"
  # deploy:
  #   runs-on: ubuntu-latest
  #   environment: production
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v2
